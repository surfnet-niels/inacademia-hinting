Deploy guide for IdP Hinting software
==============================================

IdP hinting is a feature of InAcademia that allows merchants to hint to InAcademia which Institution should be used to authenticate. This allows them to present a discovery in their own local system not having to use the generic Inacademia (nordunet based) Discovery servcie.
An Idp Hint is presented to InAcademia as a sting hash. The hashes are generated by this script and the hash + name of the institution is uploaded to a public github repository so it can be cnsumed by the merchant.
IdP hints are generated based on eduGAIN metadata, which is downloaded and processed. As a result of the processing teh software created 2 sets f files: A public set which contains hints 1 one big file but also on a per country file. In addition a second set of files contains admin data which holds information on what entities were process, but also the ones that were white and blacklisted be cause of teh config setting for the tool.

The idp hint software is delivered as a stand alone docker, which has no externl dependencies (apart from access to eduGAIN metadata and the ability to commit to a public and a private git repository.

Start with an Ubuntu 16.04 or 18.04 minimal VM

## Dependencies

First, update your existing list of packages:
    sudo apt update

Install git
    sudo apt install git nano

Next, install a few prerequisite packages which let apt use packages over HTTPS:
    sudo apt install apt-transport-https ca-certificates curl software-properties-common

Then add the GPG key for the official Docker repository to your system:
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -

Add the Docker repository to APT sources:
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable"

Next, update the package database with the Docker packages from the newly added repo:
    sudo apt update

Finally, install Docker:
    sudo apt install docker-ce

## Installing and configuring the IdP Hinting bundle

We are assumign the VM is using a ubuntu user. Hence we will put all stuff into /home/ubuntu

Pull the idp_hinting from the inacademia development repo:
    git clone https://github.com/inacademia-development/inacademia-hinting.git

move into the bundle directory
    cd inacademia-hinting

the docker container uses a dedicated volume to put the admin data on. we must first create it:
    sudo docker volume create inacademia_admin_data

set the config of the docker by updatign the contents of the config dir.
    cd config

First make sure we have an ssh key we can use for r/w on both geant gitlab as well as on the InAcademia public github repository
Ask Niels for a private key and put it the users .ssh directory "id_rsa_inacademia"
Make sure the key can only be read by the ubuntu user:
    chmod 600 /home/ubuntu/.ssh/id_rsa_inacademia

While we can set this based on the existing config_example, better is to update based on the geant gitlab epository
    rm blacklisted_keywords.txt 
    rm idp_whitelisted_entities.txt 

    GIT_SSH_COMMAND='ssh -i ~/.ssh/id_rsa_inacademia' git clone git@gitlab.geant.org:inacademia/idp_hinting_config.git ~/inacademia-hinting/config

Add a link to the private key in the config dir also
    ln -s ~/.ssh/id_rsa_inacademia .

You should now have a config dir a so:
ubuntu@idp-hint-deploytest:~/inacademia-hinting/config$ ls -l
total 20
-rw-rw-r-- 1 ubuntu ubuntu   84 Apr 23 13:24 README.md
-rw-rw-r-- 1 ubuntu ubuntu   92 Apr 23 13:24 blacklisted_keywords.txt
-rw-rw-r-- 1 ubuntu ubuntu  217 Apr 23 13:24 hinting.cnf
lrwxrwxrwx 1 ubuntu ubuntu   35 Apr 23 13:24 id_rsa_inacademia -> /home/ubuntu/.ssh/id_rsa_inacademia
-rw-rw-r-- 1 ubuntu ubuntu   51 Apr 23 13:24 idp_whitelisted_entities.txt
-rw-rw-r-- 1 ubuntu ubuntu 2654 Apr 23 13:24 known_hosts

## Building and running the docker

go one directory up and run the builder script:
    sudo ./build_hinting.sh

Once build succesfully, test if it run ok:
    sudo ./run_hinting.sh

Assumign all of that went ok, you should now have an updated output reposities at the endpoins you configured in config/hinting.cnf

Now add the scripts to run this periodically, add lines to CRON to start idp_hinting hourly and prune the docker every night at 3.30 AM. In case the image does not exits, it will be automatically rebuild the fist time it is started in run_hinting.sh
0 * * * * /home/ubuntu/inacademia-hinting/run_hinting.sh  >> /var/log/inacademia_hinting.log 2>&1
30 3 * * * /home/ubuntu/inacademia-hinting/prune_dockers.sh  >> /var/log/inacademia_hinting.log 2>&1
